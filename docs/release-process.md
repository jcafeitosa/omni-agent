# Release Process

## Versioning

- Follow semantic versioning: `MAJOR.MINOR.PATCH`.
- Update `CHANGELOG.md` under `[Unreleased]` during development.

## Cut a release

1. Ensure CI is green on `main`.
2. Move release notes from `[Unreleased]` to a versioned section in `CHANGELOG.md`.
3. Tag release:

```bash
git tag v0.1.0
git push origin v0.1.0
```

4. GitHub workflows run:
- build + test
- packs all workspaces as `.tgz` artifacts
- creates GitHub Release with autogenerated notes + artifacts
- triggers package publication workflow (`npm` and `GitHub Packages`)

## Workflows

- `.github/workflows/release.yml`: build/test + GitHub Release + artifact upload
- `.github/workflows/packages.yml`: publish packages on release event or manual dispatch
- `.github/workflows/release-check.yml`: preflight validation for tags

## Required secrets

- `NPM_TOKEN`: required to publish to `registry.npmjs.org`
- `GITHUB_TOKEN`: built-in, used by workflow for GitHub Packages

## npm configuration

Repository root includes `.npmrc` with:

- npmjs as default registry
- auth token from `NPM_TOKEN`
- GitHub Packages token from `GITHUB_TOKEN`

For local publishing, export token before running publish scripts:

```bash
export NPM_TOKEN=...
npm run release:publish:npm
```

If local npm cache has permission issues, use a workspace-local cache:

```bash
NPM_CONFIG_CACHE=.npm-cache npm run release:publish:npm
```

## GitHub Packages scope requirement

For npm packages on GitHub Packages, the package scope must match the repository owner (`@<owner>/<name>`).

Current packages use scope `@omni-agent/*`. If the repo owner is different (for example `jcafeitosa`), GitHub Packages publish is skipped until you either:

1. Move repo to org/user matching `omni-agent`, or
2. Rename package scopes to `@jcafeitosa/*`.

## Rollback

- If publish fails partially, deprecate affected npm versions and cut a patch release.
- If runtime regression is found, revert on `main` and release `PATCH+1`.
